name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 3ï¸âƒ£ Spring Boot ë¹Œë“œ
      - name: Build Spring Boot App
        run: ./gradlew clean build -x test

      # 4ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t soi-backend:latest .

      # 5ï¸âƒ£ GitHub Secretsì— ì €ì¥ëœ ENV_FILE ê¸°ë°˜ .env ìƒì„±
      - name: Create .env file from GitHub Secrets
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "âœ… .env file generated from GitHub Secrets"
          cat .env

      # 6ï¸âƒ£ Docker ì´ë¯¸ì§€ ì €ì¥ + ì••ì¶•
      - name: Save Docker image & compress with env and compose
        run: |
          docker save soi-backend:latest -o soi-backend.tar
          tar -czvf soi-deploy.tar.gz soi-backend.tar .env docker-compose.yml

      # 7ï¸âƒ£ EC2 ì„œë²„ë¡œ ì—…ë¡œë“œ (/home/ec2-user/soi)
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "soi-deploy.tar.gz"
          target: "/home/ec2-user/soi/"

      # 8ï¸âƒ£ EC2ì—ì„œ ìë™ ë°°í¬ ì‹¤í–‰
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/ec2-user/soi
            cd /home/ec2-user/soi

            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬"
            docker compose down || true

            echo "ğŸ“¦ ì••ì¶• í•´ì œ"
            tar -xzvf soi-deploy.tar.gz

            echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¡œë“œ"
            docker load -i soi-backend.tar

            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker compose up -d --build

            echo "âœ… ë°°í¬ ì™„ë£Œ"